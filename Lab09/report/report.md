---
## Front matter
title: "Отчёт по лабораторной работе №9"
subtitle: "Управление SELinux"
author: "Сулейм Гамбердов"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true
toc-depth: 2
lof: true
lot: true
fontsize: 12pt
linestretch: 1.5
papersize: a4
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
    - spelling=modern
    - babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float}
  - \floatplacement{figure}{H}
---

# Цель работы

Получить навыки работы с контекстом безопасности и политиками SELinux.

# Ход выполнения

## Управление режимами SELinux

1. В терминале получены права администратора с помощью команды **su**.  
   Это позволило выполнять системные команды, требующие привилегий *root*.

2. Проверено текущее состояние SELinux командой **sestatus -v**.  
   Из вывода видно:  
   - **SELinux status: enabled** — механизм безопасности SELinux включён.  
   - **Loaded policy name: targeted** — используется политика *targeted*, защищающая только ключевые системные службы.  
   - **Current mode: enforcing** — активен режим принудительного применения политик.  
   - **Mode from config file: enforcing** — конфигурация также задаёт принудительный режим.  
   - **Policy MLS status: enabled** — включена многоуровневая защита.  
   - Разделы *Process contexts* и *File contexts* показывают текущие контексты безопасности процессов и файлов, например:  
     `/usr/sbin/sshd` — `system_u:system_r:sshd_t:s0-s0:c0.c1023`.  
     Это означает, что служба **sshd** выполняется в собственном домене безопасности.  

   ![Вывод команды sestatus -v](Screenshot_1.png){ #fig:001 width=80% }

3. Проверен режим SELinux с помощью **getenforce**.  
   Вывод *Enforcing* подтвердил активный режим принудительного применения политик.

4. Режим SELinux изменён на разрешающий (**Permissive**) командой **setenforce 0**.  
   Повторная проверка **getenforce** показала *Permissive*.  
   В этом режиме нарушения политик только фиксируются в журнале, но не блокируются.  

   ![Изменение режима SELinux на Permissive](Screenshot_2.png){ #fig:002 width=80% }

5. Для полного отключения SELinux открыт файл **/etc/sysconfig/selinux** с помощью редактора *nano* и изменена строка **SELINUX=disabled**.  
   После сохранения изменений система была перезагружена.  

   ![Отключение SELinux в конфигурационном файле](Screenshot_3.png){ #fig:003 width=80% }

6. После перезапуска и входа под пользователем root команда **getenforce** показала *Disabled*, что означает полное отключение SELinux.  

   ![SELinux отключён](Screenshot_4.png){ #fig:004 width=80% }

7. Попытка включить SELinux командой **setenforce 1** завершилась сообщением *SELinux is disabled*.  
   Это подтверждает, что между состояниями *disabled* и *enforcing* невозможно переключаться без перезагрузки системы.  

8. Для возврата к принудительному режиму SELinux снова открыт файл **/etc/sysconfig/selinux** и установлено значение **SELINUX=enforcing**.  
   После этого система была перезагружена.  

   ![Включение enforcing-режима в конфигурации](Screenshot_5.png){ #fig:005 width=80% }

9. Во время загрузки появилось предупреждение о необходимости восстановления меток SELinux.  
   Сообщение **"SELinux targeted policy relabel is required"** информировало, что выполняется автоматическая перемаркировка файлов, что может занять некоторое время.  

   ![Автоматическое восстановление меток SELinux при загрузке](Screenshot_6.png){ #fig:006 width=80% }

10. После завершения загрузки команда **sestatus -v** показала, что система снова работает в режиме *enforcing*.  

   ![Проверка состояния SELinux после восстановления](Screenshot_7.png){ #fig:007 width=80% }

## Использование restorecon для восстановления контекста безопасности

1. Получены права администратора и просмотрен контекст файла **/etc/hosts** с помощью **ls -Z /etc/hosts**.  
   У файла установлен контекст **net_conf_t**, что соответствует категории сетевых конфигураций.  

2. Файл **/etc/hosts** скопирован в домашний каталог (**cp /etc/hosts ~/**).  
   Проверка **ls -Z ~/hosts** показала контекст **admin_home_t**, присвоенный файлам пользователя.  

3. При перемещении копии обратно в каталог **/etc** (**mv ~/hosts /etc**) контекст остался **admin_home_t**, что является некорректным для системного файла.  

4. Для исправления контекста выполнена команда **restorecon -v /etc/hosts**.  
   Контекст изменён с **admin_home_t** на **net_conf_t**, что подтверждает восстановление корректной метки безопасности.  

5. Повторная проверка **ls -Z /etc/hosts** показала правильный контекст **net_conf_t**.  

6. Для массового восстановления контекстов на файловой системе создан файл **/.autorelabel** с помощью **touch /.autorelabel**.  
   После перезагрузки система автоматически перемаркировала файлы, о чём сообщалось при старте системы.  

   ![Использование restorecon и autorelabel для восстановления контекста](Screenshot_8.png){ #fig:008 width=80% }

## Настройка контекста безопасности для нестандартного расположения файлов веб-сервера

1. В терминале получены полномочия администратора.  
   Это необходимо для установки и настройки веб-сервера Apache.

2. Установлены необходимые пакеты — веб-сервер **httpd** и текстовый браузер **lynx**, позволяющий тестировать локальные веб-страницы из терминала.  
   После завершения установки появилось сообщение *Complete!*, подтверждающее успешное выполнение операции.  

   ![Установка lynx и подготовка каталога /web](Screenshot_9.png){ #fig:009 width=80% }

3. Создан новый каталог **/web** для размещения пользовательского контента веб-сервера.  
   Далее в этот каталог добавлен файл **index.html** с текстом *Welcome to my web server*.  
   Это будет стартовая страница, доступная при обращении к серверу.  

4. Открыт файл конфигурации **/etc/httpd/conf/httpd.conf**.  
   В нём закомментирована строка  
   `DocumentRoot "/var/www/html"`  
   и добавлено новое значение  
   `DocumentRoot "/web"`.  

Эти изменения определяют новый путь для контента веб-сервера и задают разрешения на доступ к нему.  

![Изменение конфигурации DocumentRoot](Screenshot_10.png){ #fig:010 width=80% }

5. После сохранения изменений веб-сервер **httpd** был запущен и добавлен в автозагрузку.  
При тестовом обращении через браузер **lynx http://localhost** отобразилась стандартная страница Rocky Linux, что означает — сервер работает, но ещё не использует новый каталог /web.  

![Проверка работы веб-сервера через lynx — страница по умолчанию](Screenshot_11.png){ #fig:011 width=80% }

6. Для корректного доступа веб-сервера к каталогу **/web** необходимо было изменить контекст безопасности SELinux.  
Команда  
**semanage fcontext -a -t httpd_sys_content_t "/web(/.*)?"**  
добавила правило, указывающее, что каталог и его содержимое принадлежат типу *httpd_sys_content_t*.  
Далее команда **restorecon -R -v /web** применила изменения, обновив метки контекста безопасности.  
В результате метка каталога и файла *index.html* была изменена с *default_t* на *httpd_sys_content_t*, что позволило службе Apache безопасно их обслуживать.  

![Назначение контекста безопасности для каталога /web](Screenshot_12.png){ #fig:012 width=80% }

7. После применения новых меток и повторного обращения к серверу командой **lynx http://localhost** веб-браузер отобразил созданную пользователем страницу с текстом  
*Welcome to my web server*.  
Это подтвердило, что конфигурация выполнена корректно, а доступ к каталогу /web разрешён политикой SELinux.  

![Отображение пользовательской страницы веб-сервера](Screenshot_13.png){ #fig:013 width=80% }

## Дополнительная настройка SELinux для FTP-сервера

1. Для проверки доступных булевых параметров SELinux, связанных с FTP, использована команда **getsebool -a | grep ftp**.  
Из вывода видно, что все параметры были отключены.  

2. Далее с помощью **semanage boolean -l | grep ftpd_anon** проверено состояние переменной **ftpd_anon_write**, отвечающей за разрешение анонимной записи в FTP.  
Первоначально её значение было *(off, off)*.

3. Команда **setsebool ftpd_anon_write on** временно включила возможность записи для анонимных пользователей, что подтвердилось последующей проверкой **getsebool ftpd_anon_write**.

4. Для постоянного сохранения изменений параметр был активирован командой **setsebool -P ftpd_anon_write on**.  
Повторная проверка **semanage boolean -l | grep ftpd_anon** показала статус *(on, on)*, что означает успешное сохранение настройки.  

![Настройка булевой переменной SELinux для FTP](Screenshot_14.png){ #fig:014 width=80% }

# Контрольные вопросы

1. Чтобы временно перевести SELinux в разрешающий режим (**Permissive**), используется команда:  
   - **setenforce 0**  
   Она отключает блокировку действий, нарушающих политику SELinux, но продолжает их регистрировать в журнале.

2. Для вывода списка всех доступных переключателей (булевых параметров) SELinux применяется команда:  
   - **getsebool -a**  
   Она отображает все активные и неактивные флаги, регулирующие поведение SELinux для различных сервисов.

3. Для получения легко читаемых сообщений SELinux из журнала аудита необходимо установить пакет:  
   - **setroubleshoot-server**  
   Этот пакет позволяет интерпретировать сообщения SELinux и выводить рекомендации по устранению проблем.

4. Чтобы применить тип контекста **httpd_sys_content_t** к каталогу **/web**, необходимо выполнить следующие команды:  
   - **semanage fcontext -a -t httpd_sys_content_t "/web(/.*)?"** — добавить правило для каталога и его содержимого;  
   - **restorecon -R -v /web** — применить изменения и пересоздать корректные метки безопасности.

5. Для полного отключения SELinux требуется изменить конфигурационный файл:  
   - **/etc/sysconfig/selinux**  
   В нём необходимо установить параметр **SELINUX=disabled** и затем перезагрузить систему.

6. Все сообщения SELinux регистрируются в журнале:  
   - **/var/log/audit/audit.log**  
   В нём фиксируются все события, связанные с политиками безопасности, контекстами и нарушениями.

7. Чтобы узнать, какие типы контекстов доступны для службы **ftp**, используется команда:  
   - **semanage fcontext -l | grep ftp**  
   Она показывает все пути и типы контекстов, связанные с FTP-сервисом.

8. Если служба работает некорректно и есть подозрение, что причина в SELinux, самый простой способ проверки — временно перевести SELinux в разрешающий режим:  
   - **setenforce 0**  
   Если после этого сервис начинает работать, значит, проблема связана с политиками SELinux.

# Заключение  

В ходе лабораторной работы были изучены методы управления механизмом безопасности **SELinux**: проверка текущего состояния системы, изменение режимов работы (*enforcing*, *permissive*, *disabled*), редактирование конфигурационного файла и восстановление контекстов безопасности.  
Были отработаны практические приёмы настройки SELinux для нестандартных каталогов веб-сервера, а также использование команд **semanage** и **restorecon** для назначения правильных меток безопасности.  

